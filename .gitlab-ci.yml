image: gradle:jdk8-jammy
stages:
  - build
  - deploy
  - create
  - k8s
variables:
  GRADLE_OPTS: "-Dorg.gradle.daemon=false"

before_script:
  - GRADLE_USER_HOME="$(pwd)/.gradle"
  - export GRADLE_USER_HOME
#  - sleep 30m
build:
  stage: build
  script: gradle build
  only:
    - tags
deploy:
  stage: deploy
  script:
    - 'gradle publish'
  only:
    - tags
  artifacts:
    paths:
      - /builds/muhammed.labeeb/java_build_gradle/app/build/libs
create-image:
  image: docker:19.03.6
  services:
    - docker:19.03.6-dind
  stage: create
  script:
  #  - sleep 30m
    - docker build -t $GITLAB_REGISTRY_URL:v$CI_COMMIT_TAG .
    - echo $GIT_LAB_PASSWORD | docker login -u $GITLAB_USERNAME --password-stdin $GITLAB_REGISTRY_URL 
    - docker push $GITLAB_REGISTRY_URL:v$CI_COMMIT_TAG
  dependencies:
    - deploy
  only:
    - tags
deploy_k8s:
  stage: k8s
  image: dtzar/helm-kubectl
  only:
    - tags
  script:
    - sleep 30m
    - cp /builds/muhammed.labeeb/java_build_gradle/config.yml $HOME/.kube/config
    - cd deployment
    - sed -i "s/<VERSION>/${CI_COMMIT_TAG}/g" deployment.yaml

